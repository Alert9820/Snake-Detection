<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Nearby Medical Services</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 60vh; }
    #controls { padding: 10px; background: #f5f5f5; }
    select, button { padding: 5px; margin: 5px; }
    #results { max-height: 40vh; overflow-y: auto; padding: 10px; }
    .hospital { padding: 8px; border-bottom: 1px solid #ddd; }
    .call-btn { background: green; color: white; padding: 5px; text-decoration: none; border-radius: 4px; }
  </style>
</head>
<body>

<div id="controls">
  <label>Search Radius:</label>
  <select id="radius">
    <option value="1000">1 km</option>
    <option value="3000">3 km</option>
    <option value="5000" selected>5 km</option>
    <option value="10000">10 km</option>
  </select>
  <button onclick="findHospitals()">Find Nearby</button>
</div>

<div id="map"></div>
<div id="results"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, userMarker, markersLayer;

function initMap(lat, lon) {
  map = L.map('map').setView([lat, lon], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  userMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup("You are here").openPopup();

  markersLayer = L.layerGroup().addTo(map);
}

function findHospitals() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    let lat = pos.coords.latitude;
    let lon = pos.coords.longitude;
    if (!map) initMap(lat, lon);
    else {
      map.setView([lat, lon], 14);
      userMarker.setLatLng([lat, lon]);
    }

    let radius = document.getElementById('radius').value;
    let query = `
      [out:json];
      (
        node["amenity"~"hospital|clinic|pharmacy"](around:${radius},${lat},${lon});
        way["amenity"~"hospital|clinic|pharmacy"](around:${radius},${lat},${lon});
        relation["amenity"~"hospital|clinic|pharmacy"](around:${radius},${lat},${lon});
      );
      out center;
    `;
    let url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

    document.getElementById('results').innerHTML = "<p>Loading...</p>";
    markersLayer.clearLayers();

    let res = await fetch(url);
    let data = await res.json();
    let listHTML = "";

    data.elements.forEach(el => {
      let name = el.tags.name || "Unnamed";
      let phone = el.tags.phone || el.tags.contact_phone || "";
      let address = el.tags["addr:full"] || `${el.tags["addr:street"] || ""} ${el.tags["addr:city"] || ""}`;
      let latlng = el.type === "node" ? [el.lat, el.lon] : [el.center.lat, el.center.lon];

      markersLayer.addLayer(L.marker(latlng).bindPopup(`<b>${name}</b><br>${address}`));

      listHTML += `<div class="hospital">
        <strong>${name}</strong><br>
        ${address || "No address"}<br>
        ${phone ? `<a class="call-btn" href="tel:${phone}">Call</a>` : ""}
      </div>`;
    });

    document.getElementById('results').innerHTML = listHTML || "<p>No results found.</p>";

  }, err => {
    alert("Error getting location: " + err.message);
  }, { enableHighAccuracy: true });
}
</script>

</body>
  </html>
